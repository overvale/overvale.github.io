<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width = device-width" />
<link rel="stylesheet" type="text/css" href="/style.css" />
<title>Confirm Killing Modified Buffers @overvale.com</title>
</head>
<body>
<header><p><a href="/">Overvale</a></p></header>
<main class="content-page emacs">
<div class="page-layout">
<aside class="sidebar-left">
<nav class="tree-nav" aria-label="Site Navigation">
<ul class="tree-root">
  <li class="tree-group"><span class="tree-group-label">Writing</span>
    <ul>
      <li><a href="/writing/structured-to-innovate">DARPA, Skunk Works, &amp; Bell Labs: Structured to Innovate</a></li>
      <li><a href="/writing/systems-engineering-nasa">Systems Engineering at NASA</a></li>
      <li><a href="/writing/systems-engineering-vfx">Systems Engineering for Visual Effects</a></li>
    </ul>
  </li>
  <li><a href="/notes/">Notes</a></li>
  <li><a href="/emacs/" class="active">Emacs Notes</a></li>
  <li><a href="/links">Links</a></li>
</ul>
</nav>
</aside>

<article class="content-main">
<h1>Confirm Killing Modified Buffers</h1>

<p class="date">2021-09-04</p>

<p>In Emacs, a file-visiting buffer is one where the buffer displays the contents of a file. A regular buffer simply displays text: the output of a command, documentation, messages, an unsaved document, etc. Emacs uses these regular buffers to display its user interface in the same way that most apps use windows.</p>
<p>When killing a file-visiting buffer that has unsaved changes Emacs will prompt you to confirm that action since you would lose those unsaved changes to the file. However, when killing a modified regular buffer Emacs does not prompt you at all. I imagine the reasoning for this is simply that Emacs creates and kills many temporary buffers to display its user interface, and no user wants to confirm killing every one of those buffers. This means that Emacs assumes the user does not want to lose modifications to file-visiting buffers but that losing modifications to regular buffers is just fine.</p>
<p>In most cases this is a fair assumption, but there are times when the user probably wants Emacs to prompt them for confirmation when killing modified regular buffers. For example, after the user has explicitly created a buffer with a particular name. In that case the user probably wants to confirm the loss of that data.</p>
<p>You can, however, protect against the loss of modified regular buffers when you <em>exit</em> Emacs by setting the buffer-local variable <code>buffer-offer-save</code>. But no such variable exists for when you try to kill a modified buffer. This means <em>there is no mechanism for protecting modified regular buffers from being killed.</em></p>
<p>As with anything Emacs, it is not hard to fix this problem. You simply need a new buffer-local variable you can set when you want to protect a regular buffer, and a function to attach to <code>kill-buffer-query-functions</code>.</p>
<p>This is what I have in my init file:</p>
<pre class="elisp"><code>(defvar-local buffer-confirm-kill nil
  &quot;Non-nil means confirm killing buffer when modified.
Variable is checked by `buffer-confirm-kill-p&#39;.&quot;)

(defun buffer-confirm-kill-p ()
  &quot;Return nil if buffer is modified and `buffer-confirm-kill&#39; is t.
This function is designed to be called from `kill-buffer-query-functions&#39;.&quot;
  (if (and (buffer-modified-p)
           buffer-confirm-kill)
      (yes-or-no-p
       (format &quot;Buffer %S is modified; kill anyway? &quot; (buffer-name)))
    t))

(add-hook &#39;kill-buffer-query-functions #&#39;buffer-confirm-kill-p)</code></pre>
<p>Now, one simply needs to set the variable <code>buffer-confirm-kill</code> in any buffer whose modifications you want protected. A simple example would be a function for creating a new buffer:</p>
<pre class="elisp"><code>(defun new-buffer (name)
  &quot;Create a new buffer, prompting for NAME.&quot;
  (interactive
   (list (read-string
          &quot;Create buffer (default \&quot;untitled\&quot;): &quot;
          nil nil &quot;untitled&quot;)))
  (let ((buffer (generate-new-buffer name)))
    (switch-to-buffer buffer)
    (setq-local buffer-offer-save t)
    (setq-local buffer-confirm-kill t)))</code></pre>
<p>This new buffer is now protected from data-loss when the user attempts to either exit Emacs or kill the buffer.</p>

<nav class="footer-nav tree-nav" aria-label="Site Navigation">
<ul class="tree-root">
  <li class="tree-group"><span class="tree-group-label">Writing</span>
    <ul>
      <li><a href="/writing/structured-to-innovate">DARPA, Skunk Works, &amp; Bell Labs: Structured to Innovate</a></li>
      <li><a href="/writing/systems-engineering-nasa">Systems Engineering at NASA</a></li>
      <li><a href="/writing/systems-engineering-vfx">Systems Engineering for Visual Effects</a></li>
    </ul>
  </li>
  <li><a href="/notes/">Notes</a></li>
  <li><a href="/emacs/" class="active">Emacs Notes</a></li>
  <li><a href="/links">Links</a></li>
</ul>
</nav>

<footer>
</footer>
</article>

<aside class="sidebar-right">
</aside>
</div>
</main>
</body>
</html>
